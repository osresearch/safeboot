



<!doctype html>
<html lang="en" class="no-js">
  <head>
    

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Debian package to enable UEFI SecureBoot, enroll your own hardware backed platform key, sign the kernel and initrd, decrypt the disk with the TPM, and enable system integrity protection with dmverity">
      
      
        <link rel="canonical" href="https://safeboot.dev/attestation/">
      
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
<!--
 fill in the opengraph meta tags, with defaults from the site config
 or values in the yaml metadata for the specific page (summary and image).
-->
<meta property="og:title"
      content="tpm2-attest: TPM2 Remote Attestation">
<meta property="og:site_name" content="safeboot">
<meta property="og:url" content="https://safeboot.dev/attestation/">
<meta property="og:description"
	content="tpm2-attest is a simple way to have an untrusted Linux machine generate signed TPM quotes, validate those quotes and endorsement keys on a remote attestation server, and seal a secret message that will only be unsealable on that specific TPM.">
<meta property="og:image"
      content="https://safeboot.dev/images/tpm-header.jpg">

    
      
        <title>tpm2-attest: TPM2 Remote Attestation - safeboot</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.077507d7.min.css">
      
      
    
    
    
       <!-- Load fonts from Google -->
       
         <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
         <link rel="stylesheet" type="text/css"
             href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:300,400,400i,700%7CIBM+Plex+Sans:500,600,700%7CIBM+Plex+Mono&display=fallback" />
         <style>
           body, input {
             font-family: "IBM Plex Serif", "Helvetica Neue",
               Helvetica, Arial, sans-serif;
           }
           pre, code, kbd {
             font-family: "IBM Plex Mono", "Courier New",
               Courier, monospace;
           }
	   h1, h2, h3, h4, h5, h6 {
             font-family: "IBM Plex Sans", sans-serif;
	     font-weight: 700 !important;
           }
         </style>
       
     
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tldr" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://safeboot.dev/" title="safeboot" class="md-header-nav__button md-logo" aria-label="safeboot">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            safeboot
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              tpm2-attest: TPM2 Remote Attestation
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/osresearch/safeboot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://safeboot.dev/" title="safeboot" class="md-nav__button md-logo" aria-label="safeboot">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    safeboot
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/osresearch/safeboot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../install/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../faq/" title="Frequently Asked Questions" class="md-nav__link">
      Frequently Asked Questions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../threats/" title="Threat Model" class="md-nav__link">
      Threat Model
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Remote Attestation
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Remote Attestation" class="md-nav__link md-nav__link--active">
      Remote Attestation
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    tl;dr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attestation-protocol" class="md-nav__link">
    Attestation protocol
  </a>
  
    <nav class="md-nav" aria-label="Attestation protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initiation" class="md-nav__link">
    Initiation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quote-signing" class="md-nav__link">
    Quote signing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quote-validation" class="md-nav__link">
    Quote validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-sealing" class="md-nav__link">
    Secret sealing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-unsealing" class="md-nav__link">
    Secret unsealing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tpm-oem-certificates" class="md-nav__link">
    TPM OEM Certificates
  </a>
  
    <nav class="md-nav" aria-label="TPM OEM Certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-new-intermediate-certificates" class="md-nav__link">
    Adding new intermediate certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tpms-without-ek-certificates" class="md-nav__link">
    TPMs without EK certificates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-is-this-a-shell-script" class="md-nav__link">
    Why is this a shell script?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#i-thought-remote-attestation-and-tpms-were-only-for-drm" class="md-nav__link">
    I thought remote attestation and TPMs were only for DRM?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-is-generating-a-quote-so-slow" class="md-nav__link">
    Why is generating a quote so slow?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discrete-tpm-vs-ftpm" class="md-nav__link">
    Discrete TPM vs fTPM?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../chain-of-trust/" title="Chain of Trust" class="md-nav__link">
      Chain of Trust
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../safeboot/" title="safeboot subcommands" class="md-nav__link">
      safeboot subcommands
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tpm2-attest/" title="tpm2-attest subcommands" class="md-nav__link">
      tpm2-attest subcommands
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    tl;dr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attestation-protocol" class="md-nav__link">
    Attestation protocol
  </a>
  
    <nav class="md-nav" aria-label="Attestation protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initiation" class="md-nav__link">
    Initiation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quote-signing" class="md-nav__link">
    Quote signing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quote-validation" class="md-nav__link">
    Quote validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-sealing" class="md-nav__link">
    Secret sealing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-unsealing" class="md-nav__link">
    Secret unsealing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tpm-oem-certificates" class="md-nav__link">
    TPM OEM Certificates
  </a>
  
    <nav class="md-nav" aria-label="TPM OEM Certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-new-intermediate-certificates" class="md-nav__link">
    Adding new intermediate certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tpms-without-ek-certificates" class="md-nav__link">
    TPMs without EK certificates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-is-this-a-shell-script" class="md-nav__link">
    Why is this a shell script?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#i-thought-remote-attestation-and-tpms-were-only-for-drm" class="md-nav__link">
    I thought remote attestation and TPMs were only for DRM?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-is-generating-a-quote-so-slow" class="md-nav__link">
    Why is generating a quote so slow?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discrete-tpm-vs-ftpm" class="md-nav__link">
    Discrete TPM vs fTPM?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Remote Attestation</h1>
                
                <p><img alt="TPM on a server mainboard" src="../images/tpm-header.jpg" /></p>
<p>When the user wants to connect to another computer over the network,
they typicaly authenticate with a password and some sort of two factor
token to prove to the remote system that they are authorized to
make the connection.  In high assurance applications, however, it is
also important that the local computer be able to attest to the remote
server that the local computer itself is both authorized and is also
in a known configuration.</p>
<p>The TPM provides a mechanism to do this sort of remote attestation,
similar to the way that the disk encryption keys are "<em>sealed</em>" based
on the PCRs and only decrypted if the platform configuration matches
the sealed values.  The <code>tpm2-tools</code> package has many of the pieces,
but it is at too low a level for humans to use.  Other parts of the
validation exist in the <code>openssl</code> package, but again are not easily
used and require format conversions from the TPM formats.</p>
<p><a href="../tpm2-attest/"><code>tpm2-attest</code></a> attempts to wrap all of the various parts of
those two packages into a simple script that provides the four
main attestation functions: sign a quote, validate a signed quote,
seal a secret for a specific TPM, and unseal it with that TPM.</p>
<h2 id="tldr">tl;dr</h2>
<ul>
<li>Client: Get <code>$nonce</code> and <code>$pcrs</code> from server</li>
<li>Client: <code>tpm2-attest $nonce $pcrs &gt; quote.tgz</code></li>
<li>Client: Send <code>quote.tgz</code> to server</li>
<li>Server: <code>tpm2-attest verify-and-seal quote.tgz $nonce &lt; secret.txt &gt; cipher.bin</code></li>
<li>Server: Send <code>cipher.bin</code> to client</li>
<li>Client: <code>tpm2-attest unseal &lt; cipher.bin &gt; secret.txt</code></li>
<li>Client: Use <code>secret.txt</code> to decrypt disk, authenticate to network, etc</li>
</ul>
<hr />
<h2 id="attestation-protocol">Attestation protocol</h2>
<p>The protocol requires a few round-trips between the local machine
(the client) and the remote attestation machine (the server), and all
comunication between the Client and the Server can be in the clear.
There is no sensitive data exchanged -- the <code>quote.tgz</code> file contains
only public keys and PCR values that are essentially public, and the
<code>cipher.bin</code> reply is encrypted with the TPM's Endorsement Key, so it
should only be unsealable by that specific TPM.</p>
<p>A MITM could substitute a different EK/AK pair, although this does
not allow them to masquarade as the TPM of the attesting machine since
they do not have the EK for that TPM, and the real TPM won't be able
to decrypt the response from the attestation server since it would be
encrypted with the wrong EK.</p>
<p>The keys involved are:</p>
<ul>
<li>CA Root, stored hopefully securely by the CA</li>
<li>TPM Manufacturer key, a signing-only key signed by the CA Root, and stored hopefully securely by the OEM</li>
<li>TPM Endorsement key (<code>EK</code>), an encryption key, generated in the TPM(?) and stored in the TPM hardware device</li>
<li>TPM Endorsement certificate (<code>ek.crt</code>), signed by the TPM manufacturer, often stored in the TPM NVRAM</li>
<li>Attestation Key (<code>AK</code>), a signing-only key generated by the TPM, but not signed by it (for inexplicable reasons), used to sign the PCR quotes</li>
</ul>
<p>The protocol between the client and the server goes in four phases: communication initiation, quote signing, quote validation, and secret sealing</p>
<h3 id="initiation">Initiation</h3>
<ul>
<li>Client contacts the attestation server, requests a nonce that is used to prevent reply attacks, and the list of PCRs to be signed.</li>
<li>Server sends the nonce (in the clear is fine, since it is literally a random number)</li>
</ul>
<h3 id="quote-signing">Quote signing</h3>
<div class="highlight"><pre><span></span><code>tpm2-attest quote $nonce $pcrs &gt; quote.tgz
</code></pre></div>

<p>With this command the client machine will:</p>
<ul>
<li>Extracts the public part of the TPM Endorsement Key and the x509 certificate signed by the TPM manufacturer</li>
<li>Generates a signing-only Attestation Key (<code>AK</code>) inside the TPM and exports the public key (<code>ak.pub</code>)</li>
<li>Uses the TPM to sign a "quote" of the requested PCRs plus the nonce with the Attestation Key</li>
<li>Extract the TPM event log and IMA event log, if they are available</li>
<li>Bundle up all of the pieces into a tar file: <code>ek.crt</code>, <code>ek.pub</code>, <code>ak.pub</code>, <code>quote.sig</code>, <code>quote.pcr</code>, <code>quote.msg</code>, <code>eventlog</code> and the <code>nonce</code></li>
</ul>
<p>The Client then sends this quote file to the Server.</p>
<h3 id="quote-validation">Quote validation</h3>
<p>When the Server receives the quote file from the client, it runs:
<div class="highlight"><pre><span></span><code>tpm2-attest verify quote.tgz $nonce
</code></pre></div></p>
<p>With this command the server will:</p>
<ul>
<li>Validates the SSL certificate chain on the client TPM EK cert to ensure that it came from a real TPM</li>
<li>Validates that the quote is signed by the AK with the correct nonce (if the nonce is not checked, then this could be a replay attack by the Client)</li>
<li>Server optionally consults its list of previously enrolled devices to verify that this EK is in an owner controlled machine</li>
<li>Server optionally validates that the PCRs match the expected values</li>
<li>Server optoinally validates that the TPM event log produces the set of
PCR values in the quote</li>
</ul>
<p>If the command fails, then something is likely wrong on the Client side
and requires remediation.  The Server should not proceed to sealing a
secret for the Client.</p>
<p>Suprisingly, the Attestation Key is not signed by the Endorsement Key,
so the Server has to check the EK certificate to ensure that it came from
a real TPM. Additional, the Server must check the AK attributes to ensure
that it has <code>fixedtpm</code> and <code>sensitivedataorigin</code> set, which indicates that
the AK was generated inside the TPM. Even with these checks, the Server is
still trusting that the TPM hardware implements <code>tpm2_activatecredential</code>
with all of these checks correctly done, since the sealed data is encrypted
with the EK, not the AK.  (Like many things with the TPM2, this is a really
baroque way to organize the keys).</p>
<h3 id="secret-sealing">Secret sealing</h3>
<p>Assuming the validation passed, the server can seal secret data such
that only the TPM that produced the signed attestation will be able to
unseal it, and has faith that the TPM will not unseal it if it has been
reset (to prevent attacks that reboot into untrusted firmware):</p>
<div class="highlight"><pre><span></span><code>cat secret.txt | tpm2-attest seal quote.tgz &gt; cipher.bin
</code></pre></div>

<p>With this command the Server will:</p>
<ul>
<li>Encrypt a secret message (which could be a disk encryption key, a network access token, or whatever) with the TPM's EK, along with the hash of the AK.</li>
</ul>
<p>The Server then sends this encrypted blob to the Client.</p>
<p>Note that there is a <code>verify-and-seal</code> that combines both the quote validation
and the sealing of the data to the attestation key in one step:</p>
<div class="highlight"><pre><span></span><code>cat secret.txt | tpm2-attest seal quote.tgz $nonce &gt; cipher.bin
</code></pre></div>

<h3 id="secret-unsealing">Secret unsealing</h3>
<p>Once the Client receives the sealed blob from the Server, it attempts
to unseal it with the Attestation Key context that is left over from the
initial quote signing:</p>
<div class="highlight"><pre><span></span><code>cat cipher.bin | tpm2-attest unseal ak.ctx &gt; secret.txt
</code></pre></div>

<p>With this command, the Client and TPM will:</p>
<ul>
<li>Initiates an encrypted session with the TPM and sends the blob to it.</li>
<li>The TPM checks that the hash of the AK matches one that it generated and that it hasn't rebooted since then. If these checks pass, the TPM uses its private EK to decrypt the blob.</li>
<li>Client receives the secret message over the encrypted channel to the TPM</li>
</ul>
<p>At this point the Client can use the shared secret to authenticate to
the Server, a network, or decrypt it's disk, or whatever.  The TPM is
no longer involved.</p>
<hr />
<h2 id="tpm-oem-certificates">TPM OEM Certificates</h2>
<p>A key part of the remote attestion is being able to trust that the TPM hardware
is produced by a TPM manufacturer.  Much like SSL Certs for websites, the
TPM's Endorsement Key is signed by the OEM with their Intermediate CA,
which is signed by a Root CA.  Unlike SSL, the Root CAs are often not in
the system's <code>/etc/ssl/certs/</code> directory, and not easily accessible online.
Some OEMs publish them in datasheets
(<a href="https://www.st.com/content/ccc/resource/technical/digital_certificates/tpm_certificates/group0/1b/0c/f0/6a/76/d4/49/5c/DM00213539/files/en.DM00213539.pdf/jcr:content/translations/en.en.DM00213539.pdf">ST TPM EK certificates</a>),
some have online portals to select per-device intermediate certs
(<a href="https://www.infineon.com/cms/en/product/promopages/optiga_tpm_certificates/">Infineon Optiga certificates</a>),
and some just say "<em>Contact manufacturer for more details</em>"
(<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8872-TPM-AT97SC3205-3205T-TSSOP-Addendum.pdf">Atmel/Microchip EK Configuration</a>).</p>
<p>Luckily Microsoft has a CAB file with all of their approved TPM OEMs in their
<a href="https://docs.microsoft.com/en-us/windows-server/security/guarded-fabric-shielded-vm/guarded-fabric-install-trusted-tpm-root-certificates">guide to setting up shielded VMs</a>.
These x509 certs are in DER format (<a href="https://github.com/MicrosoftDocs/windowsserverdocs/issues/4402">and have a few odd ones</a>),
so they have been converted to PEM and bundled into <code>/etc/safeboot/certs/</code> for
validating the TPM attestations.</p>
<h3 id="adding-new-intermediate-certificates">Adding new intermediate certificates</h3>
<!--
<div class="highlight"><pre><span></span><code>find certs -name &#39;*.crt&#39; -exec \
    openssl x509 -inform DER -outform PER -in &#39;{}&#39; -out &#39;{}&#39;.pem \;
</code></pre></div>
-->

<p>If you add your own TPM keys to the directory, you will need to re-build the symlinks
that OpenSSL uses for the <code>-CApath</code>:
<div class="highlight"><pre><span></span><code>c_rehash /etc/safeboot/certs/
</code></pre></div></p>
<h3 id="tpms-without-ek-certificates">TPMs without EK certificates</h3>
<p>Unfortunately not all TPMs store their EK certs in the NVRAM;
some of them require an online query to the OEM to generate the certificate.
There is the <code>tpm2_getmanufec</code> program that is supposed to help with this
process, although it hasn't been integrated into this tool yet.</p>
<hr />
<h2 id="faq">FAQ</h2>
<h3 id="why-is-this-a-shell-script">Why is this a shell script?</h3>
<p>It is often desirable to perform a remote attestion inside of an <code>initrd</code>,
where there aren't fancy runtimes for Python or more advanced languages.
So the quote generation needs to be written assuming very limited resources,
as does the response unsealing.</p>
<p>The remote attestation server side could be implemented entirely in a
more civilized language, especially since the Server does not require
any TPM interaction at all -- all of its work is done in software and
can be run as an ordinary user.</p>
<p>As an example of moving some functionality into better languages, the
<code>tpm2-eventlog-validate</code> tool that parses the TPM2 event log and generates
expected PCR values is written in Python.</p>
<h3 id="i-thought-remote-attestation-and-tpms-were-only-for-drm">I thought remote attestation and TPMs were only for DRM?</h3>
<p>One of the big fears in the free software community was that TPM's
would be used to lockdown the devices and implement DRM.
That hasn't developed in general purpose computers and
<a href="https://mjg59.dreamwidth.org/24818.html?thread=928242">mjg59's TPM guide concludes with</a>
"<em>the current state of technology doesn't make them useful for practical limitations of end-user freedom</em>".
There's a far bigger threat to user freedom in the locked-down world
of mobile devices; currently most x86 machines allow rekeying with user
keys, so the software (but not the firmware) is still under owner control.</p>
<p>Remote Attestation can be used bidirectionally as well - it allows the
server to attest to the client that the machine is in a trustworthy state.
This is perhaps an even more valuable use case: you might have fairly tight
physical control of your personal machine, but a bare metal server in a data
center is potentially open to attacks by the cloud operator as well as the
previous tenants.  Having attestations as to the firmware and the OS configuration
can make it more trustable.</p>
<h3 id="why-is-generating-a-quote-so-slow">Why is generating a quote so slow?</h3>
<p>There is lots of traffic between the <code>tpm2-attest</code> program and the TPM
during the attestation process, and the TPM is not a fast device.
Read the Endorsement Key (EK) and EK Certificate take a few hundred
miliseconds, signing the quote takes another few hundred, etc.
The process used to take around 20 seconds, since the TPM had to generate
a new RSA Attestation Key (AK) to sign the PCR quote, and generating an RSA
key requires finding large primes with certain values.  The AK was replaced
with ECC, which is much faster to generate.</p>
<p>Creating a new one each time should not be necessary; several attestation protocols
use a pregenerated AK that is persistent in the TPM, except that opens up
a race condition between generating a quote and receiving the sealed
data.  The <em>quote</em> includes the reboot count, but the <em>sealed data</em>
does not reference it, so the TPM will unseal it if the AK is still
valid, even if an attacker has rebooted into an untrustworthy state
inbetween generating the quote and receiving the sealed response.
By creating an ephemeral AK (with the <code>stclear</code> bit set in the
attributes), the TPM will not allow it to be persisted and will refuse
to reload it when the reboot counter increments.</p>
<h3 id="discrete-tpm-vs-ftpm">Discrete TPM vs fTPM?</h3>
<p>The Discrete TPM is potentially a hardware weakpoint; a physically
proximate adversary could remove the TPM from a machine and connect
it to an untrusted device and then masquarade as the device to which
the TPM had been connected.  This would also potentially allow them to
extract any sealed disk encryption keys, <a href="../threats/">as described on the threat
model page</a>, and is one of the advantages of an fTPM inside
the Management Engine.</p>
<p>A proximate attacker could also interfere with the LPC
or i2c bus of a Discrete TPM using something like
<a href="https://www.nccgroup.com/uk/our-research/tpm-genie/">the TPM Genie</a>,
which allow them to both modify the hashes sent to the TPM during PCR
extension operations, and read the unsealed secrets when they are returned
if the TPM didn't support secret sessions.</p>
<p>However, the fTPM is a pure-software application inside the ME and
potentially allows an attacker with code execution on the ME to find
the sealing secrets that are used to protect the TPM keys in the ME
NVRAM, which would allow attacks against the quoting and attestation
process.</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 10, 2020</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../threats/" title="Threat Model" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Threat Model
              </div>
            </div>
          </a>
        
        
          <a href="../chain-of-trust/" title="Chain of Trust" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Chain of Trust
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>