
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Debian package to enable UEFI SecureBoot, enroll your own hardware backed platform key, sign the kernel and initrd, decrypt the disk with the TPM, and enable system integrity protection with dmverity" name="description"/>
<link href="https://safeboot.dev/install/" rel="canonical"/>
<link href="../images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.2.3, mkdocs-material-7.3.6" name="generator"/>
<!--
 fill in the opengraph meta tags, with defaults from the site config
 or values in the yaml metadata for the specific page (summary and image).
-->
<meta content="Configuring safeboot to boot Linux more safely" property="og:title"/>
<meta content="safeboot" property="og:site_name"/>
<meta content="https://safeboot.dev/install/" property="og:url"/>
<meta content="Instructions for configuring the safeboot package on Ubuntu 20.04 and setting up the hardware Yubikey, the TPM sealed disk encryption, and the System Integrity Protection Mode." property="og:description"/>
<meta content="https://safeboot.dev/images/installation-header.jpg" property="og:image"/>
<title>Configuring safeboot to boot Linux more safely - safeboot</title>
<link href="../assets/stylesheets/main.a57b2b03.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.3f5d1f46.min.css" rel="stylesheet"/>
<!-- Load fonts from Google -->
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:300,400,400i,700%7CIBM+Plex+Sans:500,600,700%7CIBM+Plex+Mono&amp;display=fallback" rel="stylesheet" type="text/css">
<style>
           body, input {
             font-family: "IBM Plex Serif", "Helvetica Neue",
               Helvetica, Arial, sans-serif;
           }
           pre, code, kbd {
             font-family: "IBM Plex Mono", "Courier New",
               Courier, monospace;
           }
	   h1, h2, h3, h4, h5, h6 {
             font-family: "IBM Plex Sans", sans-serif;
	     font-weight: 700 !important;
           }
         </style>
<link href="../extra.css" rel="stylesheet"/>
</link></link></head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#tldr">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="safeboot" class="md-header__button md-logo" data-md-component="logo" href=".." title="safeboot">
<img alt="logo" src="../images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            safeboot
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Configuring safeboot to boot Linux more safely
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/osresearch/safeboot/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="safeboot" class="md-nav__button md-logo" data-md-component="logo" href=".." title="safeboot">
<img alt="logo" src="../images/logo.png"/>
</a>
    safeboot
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/osresearch/safeboot/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        Overview
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Installation
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Installation
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#tldr">
    tl;dr
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initial-setup">
    Initial Setup
  </a>
<nav aria-label="Initial Setup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#uefi-firmware-configuration">
    UEFI firmware configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uefi-secure-boot-signing-keys">
    UEFI Secure Boot signing keys
  </a>
<nav aria-label="UEFI Secure Boot signing keys" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#openssl-key-generation">
    OpenSSL key generation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#yubikey-key-generation">
    Yubikey key generation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#enrolling-uefi-platform-keys">
    Enrolling UEFI Platform Keys
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#signed-linux-recovery-kernel">
    Signed Linux recovery kernel
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tpm-configuration">
    TPM Configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#system-integrity-protection-mode">
    System Integrity Protection mode
  </a>
<nav aria-label="System Integrity Protection mode" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ro-and-rw-partition-setup">
    RO and RW Partition setup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hashing-and-signing-the-ro-root-filesystem">
    Hashing and signing the RO root filesystem
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updates">
    Updates
  </a>
<nav aria-label="Updates" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#root-filesystem-updates">
    Root filesystem updates
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kernel-and-initramfs-update">
    Kernel and initramfs update
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uefi-firmware-update">
    UEFI firmware update
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../faq/">
        Frequently Asked Questions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../threats/">
        Threat Model
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../attestation/">
        Remote Attestation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chain-of-trust/">
        Chain of Trust
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../safeboot/">
        safeboot subcommands
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tpm2-attest/">
        tpm2-attest subcommands
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#tldr">
    tl;dr
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initial-setup">
    Initial Setup
  </a>
<nav aria-label="Initial Setup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#uefi-firmware-configuration">
    UEFI firmware configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uefi-secure-boot-signing-keys">
    UEFI Secure Boot signing keys
  </a>
<nav aria-label="UEFI Secure Boot signing keys" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#openssl-key-generation">
    OpenSSL key generation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#yubikey-key-generation">
    Yubikey key generation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#enrolling-uefi-platform-keys">
    Enrolling UEFI Platform Keys
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#signed-linux-recovery-kernel">
    Signed Linux recovery kernel
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tpm-configuration">
    TPM Configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#system-integrity-protection-mode">
    System Integrity Protection mode
  </a>
<nav aria-label="System Integrity Protection mode" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ro-and-rw-partition-setup">
    RO and RW Partition setup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hashing-and-signing-the-ro-root-filesystem">
    Hashing and signing the RO root filesystem
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updates">
    Updates
  </a>
<nav aria-label="Updates" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#root-filesystem-updates">
    Root filesystem updates
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kernel-and-initramfs-update">
    Kernel and initramfs update
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#uefi-firmware-update">
    UEFI firmware update
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Installation</h1>
<p><img alt="Linux on a classic Butterfly Thinkpad" src="../images/installation-header.jpg"/></p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p><strong>Be careful!</strong>
When following these instructions: it is possible to lock
yourself out from your own machine if you forget some of the passwords.
It is best to try this on a non-production system until you're certain
that you understand how to use the recovery mode to fix bad kernel
signatures or hashes.</p>
</div>
<p>This guide was written for a Thinkpad X1 Carbon Gen 6 running
Ubuntu 20.04.  Unfortunately there has been churn in the <code>tpm2</code> tools,
so the Debian package does not work on 18.04.</p>
<p>The outline for configuring safeboot requires some knowledge of the
command line and familiarity with running commands as <code>root</code> with <code>sudo</code>.
Releases for the the safeboot Debian package are in <a href="https://github.com/osresearch/safeboot/releases">safeboot/releases</a>.</p>
<h2 id="tldr">tl;dr</h2>
<ul>
<li>Set UEFI SecureBoot setup mode</li>
<li>Install Ubuntu 20.04, configure encrypted LVM partition</li>
<li>Resizing '/' to 8GB during the install if you want to enable SIP</li>
</ul>
<pre><code>wget https://github.com/osresearch/safeboot/releases/download/release-0.7/safeboot_0.7_amd64.deb
sudo apt install safeboot_0.7_amd64.deb
sudo update-initramfs -u
sudo safeboot yubikey-init /CN=foo/ # or safeboot key-init if you don't have a token
sudo safeboot uefi-sign-keys
sudo safeboot recovery-sign
sudo safeboot recovery-reboot

# Should reboot into the recovery image. Login as usual.
sudo safeboot luks-seal
sudo update-initramfs -u
sudo safeboot sip-init # if you want to enable SIP mode
sudo safeboot recovery-sign
sudo safeboot recovery-reboot

# Should reboot into the recovery image again, with `/` mounted read-only.
sudo safeboot linux-sign
sudo reboot

# Reboot one more time, now into dmverity protect Linux image...
sudo safeboot luks-seal
sudo reboot
</code></pre>
<p>After this final reboot, the UEFI SecureBoot database will have the
public signing keys, the UEFI boot manager will have entries for <code>linux</code>
(which boots with a read-only dmverity protected root filesystem)
and <code>recovery</code> (which boots with a root filesystem that can be remounted
read-write), TPM should contain the disk encryption secret sealed to
the <code>linux</code> boot mode, and now the disk should unlock automatically
as long as no one tampers with the device.</p>
<p>For more details as to how this all works, read on...</p>
<hr/>
<h2 id="initial-setup">Initial Setup</h2>
<p>This is done once when the system is being setup to use Safe Boot mode.
Note that the hardware token and key signing portions can be done offline
on a separate disconnected machine and then signed keys copied to the machine.</p>
<h3 id="uefi-firmware-configuration">UEFI firmware configuration</h3>
<p>The goal of these configuration changes are to remove several of the
easy attacks such as booting from external disks, modifying kernel or
initrd on disk, changing kernel command line parameters, as well as some
of the more esoteric ones like DMA attacks against the Thunderbolt ports
during the boot process.</p>
<ul>
<li>SecureBoot: Enter setup mode, erase keys</li>
<li>Supervisor password (do not lose it! it is very difficult to bypass)</li>
<li>Tamper switches: require supervisor password</li>
<li>Thunderbolt 3: Disabled</li>
<li>TPM: Enabled</li>
</ul>
<hr/>
<h3 id="uefi-secure-boot-signing-keys">UEFI Secure Boot signing keys</h3>
<p><img alt="Yubikey and Nano" src="../images/yubikey.jpg"/></p>
<p>UEFI Secure Boot settings that the system will only run bootloaders that
are signed by keys in the SPI flash.  By default these keys are the OEM and
Microsoft, and Microsoft will sign anyone else's key for $99, so it is
important to replace these keys with ones under control of the computer
owner. There is typically a signed "shim" that transfers control to the
unsigned grub bootloader and kernel, which is problematic for security.</p>
<p>A safer way to boot is to package the kernel, initrd and command line
into a single EFI executable that is signed by the computer owner's
key.  This also reduces the attack surface by removing <code>grub</code> and
the overly complicated config files, as well as speeds up the boot
process a little bit.</p>
<p>The owner key can be generated by openssl and stored offline, although
using a hardware token like a yubikey greatly enhances the security
of the system since even with root access an attacker can't
gain persistence in the <code>/</code> or in the kernel.  </p>
<h4 id="openssl-key-generation">OpenSSL key generation</h4>
<p>First step is to generate a new key that will be used for UEFI SecureBoot:</p>
<pre><code>sudo safeboot key-init /CN=foo/OU=bar/O=example.com/
</code></pre>
<p>The <code>key-init</code> subcommand will generate a password protected RSA2048 key
and store it in <code>/etc/safeboot/</code> along with the public certificate.
The password provided here will be required to sign new kernel images
and initrds, so don't lose it!</p>
<p>TODO: What is the purpose of the x509 subject?</p>
<h4 id="yubikey-key-generation">Yubikey key generation</h4>
<p><img alt="Output of yubikey-init command" src="../images/yubikey-init.png"/></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Skip this if you have already initialized your hardware token and
enrolled your keys in the UEFI SecureBoot database.
Running it again will erase the keys from your hardware token.</p>
</div>
<p>First step is to generate a new key that will be used for UEFI SecureBoot:</p>
<pre><code>sudo safeboot yubikey-init /CN=foo/OU=bar/O=example.com/
</code></pre>
<p>The <code>yubikey-init</code> subcommand will do several steps:</p>
<ul>
<li>Use <code>ykpersonalize</code> to enable CCID mode. (TODO)</li>
<li>Generate a new private key inside the Yubikey and export the public key</li>
<li>Self-sign the public key to generate a new x509 certificate</li>
<li>Reimport the certificate into the Yubikey so that UEFI variables and images
can be signed with the hardware token.</li>
</ul>
<p>The public certificate is stored in <code>/etc/safeboot/cert.pem</code>. The private
key never leaves the hardware token so it is much more difficult for
an adversary to clone.</p>
<h4 id="enrolling-uefi-platform-keys">Enrolling UEFI Platform Keys</h4>
<p><img alt="UEFI SecureBoot setup screen" src="../images/thinkpad-x1-secureboot.jpg"/>
Replacing the UEFI Platform Key with the generated x509 cert requires
that the UEFI SecureBoot firmware be put into "<code>Setup mode</code>".  On the
Thinkpads, select <code>Reset to Setup Mode</code> and <code>Clear All Secure Boot Keys</code>,
then boot into Linux.</p>
<p><img alt="Output of uefi-sign-keys command" src="../images/uefi-sign-keys.png"/></p>
<p>To load the public key from <code>/etc/safeboot/cert.pem</code> into the UEFI
secure boot key database:</p>
<pre><code>sudo safeboot uefi-sign-keys
</code></pre>
<p>Once the key has been generated, the x509 certificate needs to be
reformatted to be added to the UEFI Secure Boot platform key (<code>PK</code>),
Key-Exchange Key (<code>KEK</code>) and as a key database entry (<code>db</code>).  Each
of these updates needs to be signed with the Platform Key; in the
case of the PK it is self-signed.</p>
<p>The <code>safeboot uefi-sign-keys</code> subcommand will:</p>
<ul>
<li>Generate the three EFI public key variables updates (UEFI platform key (<code>PK</code>), key-exchange key (<code>KEK</code>) and database (<code>db</code>))</li>
<li>Sign the EFI variables with the Yubikey or OpenSSL key (will require a PIN authentication for each variable)</li>
<li>Store the signed public certificates into the firmware.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p><strong>Before you reboot!</strong> If you have not signed the kernel and initrd as
described above, the system will not boot and you will have to disable
UEFI Secure Boot to get back into the machine.</p>
</div>
<hr/>
<h3 id="signed-linux-recovery-kernel">Signed Linux recovery kernel</h3>
<p><img alt="Output of sign-kernel" src="../images/sign-kernel.png"/></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you don't have a recovery entry in the EFI boot manager on the disk,
you would need to have a USB drive signed with a key in the UEFI <code>db</code>
to recover from errors.</p>
</div>
<p>The next step is to use the Yubikey or OpenSSL key to sign and install
a recovery kernel, which will be able to read/write mount the root
filesystem, and does not have TPM sealing keys, so it will always require
a recovery password to decrypt the disk.</p>
<pre><code>sudo safeboot recovery-sign
</code></pre>
<p>This command will:</p>
<ul>
<li>Add UEFI boot menu item for recovery kernel</li>
<li>Create a directory for it in the EFI System Partition ("ESP")</li>
<li>Merge the vmlinux, initrd and command line into a single EFI executable</li>
<li>Sign the merged EFI executable</li>
</ul>
<p>Typically you will not have to redo this command since the normal
kernel will be hashed and signed during updates.  The one exception
is that once SIP mode is enabled you will have to resign the
recovery image as well to ensure that it doesn't accidentally write
to the <code>/</code> file system and corrupt the hashes.</p>
<hr/>
<h3 id="tpm-configuration">TPM Configuration</h3>
<p><img alt="Output of luks-seal subcommand" src="../images/luks-seal.png"/></p>
<p>The commands to seal the LUKS disk encryption key into the TPM,
rebuild the initrd, sign the kernel/initrd, and update the expected
PCR values are:</p>
<pre><code>sudo safeboot luks-seal
sudo safeboot linux-sign
sudo safeboot pcrs-sign
</code></pre>
<p>You only need to run <code>safeboot luks-seal</code> the very first time; the sealed
secret is included in the initrd image (stored in <code>/etc/safeboot/sealed.secret</code>).
When a new kernel or initrd is built, the platform key is used to sign both the
kernel+initrd unified image, as well as the PCRs that go with it.</p>
<p>The <code>luks-seal</code> subcommand will:</p>
<ul>
<li>Prompt for a decryption PIN, unless <code>SEAL_PIN=0</code> in <code>/etc/safeboot/local.conf</code></li>
<li>Create a new disk encryption key with random data</li>
<li>Add new key slot to disk with new key (will require the recovery password)</li>
<li>Create a TPM policy that requires the PCRs defined in <code>$PCRS</code> to match a signed block</li>
<li>Seal the disk encryption key with that policy and store it in <code>/etc/safeboot/sealed.secret</code></li>
<li>Add initramfs building hooks to unseal the secret</li>
<li>Modify <code>/etc/crypttab</code> entry to call unlock script if necessary</li>
</ul>
<p>The Trusted Platform Module serves two purposes in securing the process:
it helps validate that the firmware and boot configuration is unchanged,
and it streamlines the boot process by providing the key for encrypted disks.
On modern systems Boot Guard ensures that the initial boot block is
measured into the TPM, so a local attacker shouldn't be able to modify
the SPI flash contents to bypass the measurements, or to add their
own keys to the UEFI key database.  (Subject to various CVE's and TOCTOUs, etc)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The TPM PCRs are somewhat fragile; they include hashes of the ROM images,
the EFI executables that have been run along the boot path, etc.
For example, entering the UEFI <code>Setup</code> menu will cause different
measurements, so the TPM will not automatically unseal on the same
boot that the user has entered the setup application.  For normal
operation only a direct boot into the unified kernel+initrd will automatically
decrypt.</p>
</div>
<p>When a new kernel is installed or the initrd needs to be updated, it is only necessary
to sign the kernel and PCRs.  The sealed LUKS key is no longer changed and the recovery
password is not required.</p>
<pre><code>sudo safeboot linux-sign
sudo safeboot pcrs-sign
</code></pre>
<hr/>
<h3 id="system-integrity-protection-mode">System Integrity Protection mode</h3>
<p><img alt="dmverity merkle tree diagram" src="../images/dmverity.png"/></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The "SIP" mode is optional and ensures that even an attacker with root
priviledges can't make persistent changes to the contents of the root
filesystem. It uses the same dmverity as <a href="https://source.android.com/security/verifiedboot/dm-verity">Android's verified boot mode</a>.</p>
</div>
<p>The root of the dm-verity Merkle-tree is passed to the kernel as part of the
signed command line, ensuring that an attacker can't change anything
on the filesystem without access to the signing key.
Any modifications to the filesystem will be detected when the modified
blocks are read, allowing the system to enter recovery mode to protect
its data.</p>
<h4 id="ro-and-rw-partition-setup">RO and RW Partition setup</h4>
<p><img alt="Resizing /dev/mapper/vgubuntu-root" src="../images/lvresize-root.jpg"/></p>
<p>Resizing the root filesystem is necessary so that it can be made read-only,
as well as to make space for <code>/home</code> and <code>/var</code> as separate writable mounts,
and also so that dmverity hash computation doesn't take forever.</p>
<p>The partition resize to prepare the system for SIP mode must be done from the
recovery shell, since the root file system can't be mounted while it is
being modified.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There is a high risk of data loss if these commands are mistyped or if
the <code>resize2fs</code> fails.  Either run this on a machine that doesn't have
important data, or be certain that you have a good backup.</p>
</div>
<p>In the recovery shell, run these commands to decrypt the root disk, make sure
it is clena, resize the filesystem, and then resize the logical volume.
No need for <code>sudo</code>, since the recovery shell is always root.</p>
<pre><code>crypt_unlock
fsck -f /dev/vgubuntu/root
resize2fs /dev/vgubuntu/root 12G
lvresize --size 12G /dev/vgubuntu/root
</code></pre>
<p>Once that is done you can continue the boot into the system in recovery mode
and configure SIP.  The <code>sip-init</code> command will setup the <code>/var</code> and <code>/home</code>
filesystems, add them to <code>/etc/fstab</code>, relocate <code>/tmp</code>, build the initial
dmverity hashes, and add the signed <code>linux</code> to the efi boot menu:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There is a high risk of data loss if the <code>sip-init</code> command is unable to
complete. Either run this on a machine that doesn't have
important data, or be certain that you have a good backup.</p>
</div>
<pre><code>sudo safeboot sip-init
</code></pre>
<h4 id="hashing-and-signing-the-ro-root-filesystem">Hashing and signing the RO root filesystem</h4>
<p><img alt="Output of hash-and-sign command" src="../images/hash-and-sign.png"/></p>
<p>When exiting recovery mode it is necessary to rehash the root filesystem
and sign the kernel command line:</p>
<pre><code>sudo safeboot linux-sign
</code></pre>
<p>The <code>linux-sign</code> command will:</p>
<ul>
<li>unmount <code>/</code> and remount it <code>ro</code></li>
<li><code>fsck /</code> to ensure that it is clean</li>
<li>run <code>veritysetup format</code> to compute the Merkle-tree for <code>/dev/vgubuntu/root</code></li>
<li>write the hashes to <code>/dev/vgubuntu/hashes</code></li>
<li>merge the linux kernel, initrd, and a command line with the dmverity root hash into an EFI executable</li>
<li>sign this executable</li>
<li>and install it as the default entry in the EFI boot manager</li>
</ul>
<p>Because this might change the EFI boot manager, it is necessary to
reboot into the SIP mode and then re-seal the TPM key with
<code>safeboot luks-seal</code> as documented above.</p>
<p>TODO: Detect changes and notify the use rather than just <code>EIO</code>.</p>
<!--
* For dm-verity and read-only root:
* Separate `/`, `/var` and `/home`
* (need to show how to do this post install for 20.04)
* Two copies of `/` for A-B switching and atomic updates
-->
<h2 id="updates">Updates</h2>
<p>Nothing ever stays static, so it is important to consider the steps
for updating the system.  Frequently the root file system and kernel
will be updated together, so these steps can be batched.  Hopefully
TPM re-sealing doesn't have to happen as often, since it requires
access to the disk encryption recovery key.</p>
<h3 id="root-filesystem-updates">Root filesystem updates</h3>
<p>To re-enter recovery mode, remount the <code>/</code> filesystem read/write
and re-hash the filesystem for normal mode:</p>
<pre><code>sudo safeboot recovery-reboot
# enter the disk recovery password and login
sudo safeboot remount
# do stuff to / like apt-get ...
sudo safeboot linux-sign
sudo safeboot pcrs-sign
reboot
</code></pre>
<p>The <code>recovery-reboot</code> and <code>remount</code> subcommands:</p>
<ul>
<li>Set the UEFI Boot Manager <code>BootNext</code> to <code>recovery</code></li>
<li>Reboot the machine</li>
<li>Require a manual disk decryption recovery code</li>
<li>Runs <code>blockdev --setrw</code> to re-enable writes to the root device</li>
<li>Runs <code>mount -o rw,remount /</code> to re-enable writes to the root filesystem</li>
</ul>
<p>After updating the file system with tools like <code>apt install ...</code>,
the <code>linux-sign</code> subcommand will:</p>
<ul>
<li>Run <code>mount -o ro,remount /</code> to make the root filesystem readonly</li>
<li><code>fsck /</code> to ensure that it is clean</li>
<li><code>veritysetup format</code> to compute the merkle-tree</li>
<li>Use the Yubikey or OpenSSL key to sign the merkle-tree root hash</li>
<li>Reboot to the new read-only runtime</li>
</ul>
<p>The <code>pcrs-sign</code> subcommand will:</p>
<ul>
<li>Compute the expected PCR4 value for the new Linux kernel + initrd</li>
<li>Sign it along with the other PCR values</li>
<li>Store the signature on the PCR in a UEFI NVRAM variable</li>
</ul>
<p>If you are maintaining a fleet of machines, these could be done offline
and the block image pushed to the system for installation.  Note that
while the PCR4 value can be predicted, the other PCRs might be machine
specific.  More research is necessary for proper fleet management.</p>
<h3 id="kernel-and-initramfs-update">Kernel and initramfs update</h3>
<ul>
<li>Re-generate <code>/boot/initrd</code> and <code>/boot/vmlinuz</code></li>
<li>Merge the kernel, initrd and command line into a single EFI executable</li>
<li>Use the hardware token to sign that executable</li>
<li>Copy the signed image to the EFI boot partition</li>
<li>These could be done offline and the block image pushed to the system for installation</li>
</ul>
<h3 id="uefi-firmware-update">UEFI firmware update</h3>
<p>If there are any updates to the UEFI firmware, such as changing the
<code>Setup</code> variable, then the TPM sealed keys will no longer be accessible.
From the recovery mode should be possible to sign the new PCRs (currently
it requires more facilities than are available in the recovery initrd), or
the recovery key can be used to mount the disk and re-seal the drive.</p>
<hr/>
<div class="md-source-date">
<small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">August 23, 2020</span>
</small>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Overview" class="md-footer__link md-footer__link--prev" href=".." rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Overview
            </div>
</div>
</a>
<a aria-label="Next: Frequently Asked Questions" class="md-footer__link md-footer__link--next" href="../faq/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Frequently Asked Questions
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
            Material for MkDocs
          </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
<script src="../assets/javascripts/bundle.b1047164.min.js"></script>
</body>
</html>